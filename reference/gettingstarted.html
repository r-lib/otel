<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Getting Started — Getting Started • otel</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started — Getting Started"><meta name="description" content="This page is about instrumenting you R package or project for
OpenTelemetry. If you want to start collecting OpenTelemetry data
for instrumented packages, see
Collecting Telemetry Data in the otelsdk package."><meta property="og:description" content="This page is about instrumenting you R package or project for
OpenTelemetry. If you want to start collecting OpenTelemetry data
for instrumented packages, see
Collecting Telemetry Data in the otelsdk package."><script defer data-domain="all.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">otel</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-getting-started" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Getting Started</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-getting-started"><li><a class="dropdown-item" href="../reference/gettingstarted.html">Instrumenting R Packages</a></li>
    <li><a class="external-link dropdown-item" href="https://otelsdk.r-lib.org/reference/collecting.html">Collecting Telemetry Data (otelsdk package)</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting Started</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-lib/otel/blob/main/R/docs.R" class="external-link"><code>R/docs.R</code></a></small>
      <div class="d-none name"><code>gettingstarted.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This page is about instrumenting you R package or project for
OpenTelemetry. If you want to start collecting OpenTelemetry data
for instrumented packages, see <a href="https://otelsdk.r-lib.org/reference/collecting.html" class="external-link">
Collecting Telemetry Data</a> in the otelsdk package.</p>
    </div>


    <div class="section level2">
    <h2 id="about-opentelemetry">About OpenTelemetry<a class="anchor" aria-label="anchor" href="#about-opentelemetry"></a></h2>
    <p>OpenTelemetry is an observability framework.
<a href="https://opentelemetry.io/" class="external-link">OpenTelemetry</a> is a collection of tools,
APIs, and SDKs used to instrument, generate, collect, and export
telemetry data such as metrics, logs, and traces, for analysis in order
to understand your software’s performance and behavior.</p>
<p>For an introduction to OpenTelemetry, see the <a href="https://opentelemetry.io/docs/" class="external-link">OpenTelemetry website docs</a>.</p>
    </div>
    <div class="section level2">
    <h2 id="the-otel-and-otelsdk-r-packages">The otel and otelsdk R packages<a class="anchor" aria-label="anchor" href="#the-otel-and-otelsdk-r-packages"></a></h2>
    <p>Use the <a href="https://github.com/r-lib/otel" class="external-link">otel</a> package as a dependency if
you want to instrument your R package or project for OpenTelemetry.</p>
<p>Use the <a href="https://github.com/r-lib/otelsdk" class="external-link">otelsdk</a> package to produce
OpenTelemetry output from an R package or project that was instrumented
with the otel package.</p>
    </div>
    <div class="section level2">
    <h2 id="complete-example">Complete Example<a class="anchor" aria-label="anchor" href="#complete-example"></a></h2>
    <p>To instrument your package with otel, you need to do a couple of steps.
In this section we show how to instrument the <a href="https://github.com/r-lib/callr" class="external-link">callr</a> package.</p><div class="section">
<h3 id="add-the-otel-package-as-a-dependency">Add the otel package as a dependency<a class="anchor" aria-label="anchor" href="#add-the-otel-package-as-a-dependency"></a></h3>


<p>The first step is to add the otel package as a dependency. otel is a very
lightweight package, so may want to add it as a hard dependency. This has
the advantage that you don't need to check if otel is installed every time
you call an otel function. Add otel to the <code>Imports</code> section in
<code>DESCRIPTION</code>:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>Imports<span class="sc">:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    otel</span></code></pre><p></p></div>
<p>Alternatively, you may add otel as a soft dependency. Add otel to the
<code>Suggests</code> section in <code>DESCRIPTION</code>:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>Suggests<span class="sc">:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>    otel</span></code></pre><p></p></div>
<p>If you add otel in <code>Suggests</code>, then it makes sense to create a helper
function that checks if otel is installed and also that tracing is enabled
for the caller. You can put this function in any R file, e.g. <code>R/utils.R</code>
is a nice place for it:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">is_otel_tracing</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"otel"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/is_tracing_enabled.html">is_tracing_enabled</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="choose-a-tracer-name">Choose a tracer name<a class="anchor" aria-label="anchor" href="#choose-a-tracer-name"></a></h3>


<p>Every package should have its own tracer with a name that is unique for the
package. See <code><a href="default_tracer_name.html">default_tracer_name()</a></code> for tips on choosing a good tracer
name. Set the <code>otel_tracer_name</code> variable to the tracer name. No need to
export this symbol. In callr, we'll add</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">otel_tracer_name</span> <span class="op">&lt;-</span> <span class="st">"org.r-lib.callr"</span></span></code></pre><p></p></div>
<p>to the <code>R/callr-package.R</code> file.</p>
</div>

<div class="section">
<h3 id="create-spans-for-selected-functions">Create spans for selected functions<a class="anchor" aria-label="anchor" href="#create-spans-for-selected-functions"></a></h3>


<p>Select the functions you want to add tracing to. It is overkill to add
tracing to small functions that are called lots of times. It makes sense to
add spans to the main functions of the package.</p>
<p>The callr package has various ways of starting another R process and then
running R code in it. We'll add tracing to the</p><ul><li><p><code><a href="https://callr.r-lib.org/reference/r.html" class="external-link">callr::r()</a></code></p></li>
<li><p><code><a href="https://callr.r-lib.org/reference/rcmd.html" class="external-link">callr::rcmd()</a></code></p></li>
<li><p><code><a href="https://callr.r-lib.org/reference/rscript.html" class="external-link">callr::rscript()</a></code></p></li>
</ul><p>functions first.</p>
<p>We add to <code><a href="https://callr.r-lib.org/reference/r.html" class="external-link">callr::r()</a></code> in <code>eval.R</code>:</p>
<p></p><div class="sourceCode r"><pre><code><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">is_otel_tracing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/start_local_active_span.html">start_local_active_span</a></span><span class="op">(</span></span>
<span>      <span class="st">"callr::r"</span>,</span>
<span>      attributes <span class="op">=</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/as_attributes.html">as_attributes</a></span><span class="op">(</span><span class="va">options</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre><p></p></div><ul><li><p>We use the <code>is_otel_tracing()</code> helper function, defined above.</p></li>
<li><p><code><a href="start_local_active_span.html">start_local_active_span()</a></code> starts a span and also activates it.
It also sets up an exit handler that ends the span when the caller
function (<code><a href="https://callr.r-lib.org/reference/r.html" class="external-link">callr::r()</a></code>) exits.</p></li>
<li><p><code>options</code> contain a long list of user-provided and other option, we
add these to the span as attributes.</p></li>
</ul><p>We add essentially the same code to <code><a href="https://callr.r-lib.org/reference/rcmd.html" class="external-link">callr::rcmd()</a></code>:</p>
<p></p><div class="sourceCode r"><pre><code><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">is_otel_tracing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/start_local_active_span.html">start_local_active_span</a></span><span class="op">(</span></span>
<span>      <span class="st">"callr::rcmd"</span>,</span>
<span>      attributes <span class="op">=</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/as_attributes.html">as_attributes</a></span><span class="op">(</span><span class="va">options</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre><p></p></div>
<p>And to <code><a href="https://callr.r-lib.org/reference/rscript.html" class="external-link">callr::rscript()</a></code>:</p>
<p></p><div class="sourceCode r"><pre><code><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">is_otel_tracing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/start_local_active_span.html">start_local_active_span</a></span><span class="op">(</span></span>
<span>      <span class="st">"callr::rscript"</span>,</span>
<span>      attributes <span class="op">=</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/as_attributes.html">as_attributes</a></span><span class="op">(</span><span class="va">options</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="concurrency">Concurrency<a class="anchor" aria-label="anchor" href="#concurrency"></a></h3>


<p>An instance of the <code><a href="https://callr.r-lib.org/reference/r_session.html" class="external-link">callr::r_session</a></code> R6 class represents persistent
R background processes. We want to collect all spans from an R process into
the same trace. Since the R processes are running concurrently, their
(sub)spans will not form the correct hierarchy if we use the default,
timing-based otel mechanism to organize spans into trees. We need to
manage the lifetime and activation of the spans that represent the R
processes manually.</p>
<p>A generic strategy for handling concurrency in otel is:</p><ol><li><p>Create a new long lasting span with <code><a href="start_span.html">start_span()</a></code>.
(I.e. <em>not</em> <code><a href="start_local_active_span.html">start_local_active_span()</a></code>!)</p></li>
<li><p>Assign the returned span into the corresponding object of the concurrent
and/or asynchronous computation. Every span has a finalizer that closes
the span.</p></li>
<li><p>When running code that belongs to the concurrent computation represented
by the span, activate it for a specific R scope by calling
<code><a href="with_active_span.html">with_active_span()</a></code> or <code><a href="local_active_span.html">local_active_span()</a></code>.</p></li>
<li><p>When the concurrent computation ends, close the span manually
with its <code>$end()</code> method or <code><a href="end_span.html">end_span()</a></code>. (Otherwise it would be only
closed at the next garbage collection, assuming there are no references
to it.)</p></li>
</ol><p>This code goes into the constructor of the <code>r_session</code> object:</p>
<p></p><div class="sourceCode r"><pre><code><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">is_otel_tracing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">private</span><span class="op">$</span><span class="va">options</span><span class="op">$</span><span class="va">otel_session</span> <span class="op">&lt;-</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/start_span.html">start_span</a></span><span class="op">(</span></span>
<span>      <span class="st">"callr::r_session"</span>,</span>
<span>      attributes <span class="op">=</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/as_attributes.html">as_attributes</a></span><span class="op">(</span><span class="va">options</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre><p></p></div>
<p>The <code>finalize()</code> method (the finalizer) gets a call to close the span:</p>
<p></p><div class="sourceCode r"><pre><code><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">is_otel_tracing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">private</span><span class="op">$</span><span class="va">options</span><span class="op">$</span><span class="va">otel_session</span><span class="op">$</span><span class="fu">end</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre><p></p></div>
<p>We also add (sub)spans to other operations, e.g. the <code>read()</code> method gets</p>
<p></p><div class="sourceCode r"><pre><code><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">is_otel_tracing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">otel</span><span class="fu">::</span><span class="fu">local_session</span><span class="op">(</span><span class="va">private</span><span class="op">$</span><span class="va">options</span><span class="op">$</span><span class="va">otel_session</span><span class="op">)</span></span>
<span>    <span class="va">spn</span> <span class="op">&lt;-</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/start_local_active_span.html">start_local_active_span</a></span><span class="op">(</span><span class="st">"callr::r_session$read"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a></h3>


<p>To test your instrumentation, you need to install the
<a href="https://github.com/r-lib/otelsdk" class="external-link">otelsdk</a> package and you also need
a local or remote OpenTelemetry collector.</p>
<p>I suggest you use <a href="https://github.com/ymtdzzz/otel-tui" class="external-link"><code>otel-tui</code></a>,
a terminal OpenTelemetry viewer. To configure it, use the <code>http</code> exporter,
see <a href="environmentvariables.html">Environment Variables</a>:</p>
<p></p><div class="sourceCode sh"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="va">OTEL_TRACES_EXPORTER</span><span class="op">=</span>http <span class="ex">R</span> <span class="at">-q</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="development-mode">Development mode<a class="anchor" aria-label="anchor" href="#development-mode"></a></h3>


<p>By default otel functions never error, to avoid taking down a production
app. For development this is not ideal, we want to catch errors
early. I suggest you always turn on development mode when instrumenting a
package:</p>
<p></p><div class="sourceCode sh"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="va">OTEL_ENV</span><span class="op">=</span>dev</span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="context-propagation">Context propagation<a class="anchor" aria-label="anchor" href="#context-propagation"></a></h3>


<p>OpenTelemetry supports distributed tracing. A span (context) can be
serialized, copied to another process, and there it can be used to create
child spans.</p>
<p>For applications communicating via HTTP the serialized span context is
transmitted in HTTP headers. For our callr example we can copy the context
to the R subprocess in environment variables.</p>
<p>For example in the <code>callr:r()</code> code we may write:</p>
<p></p><div class="sourceCode r"><pre><code><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">is_otel_tracing</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/start_local_active_span.html">start_local_active_span</a></span><span class="op">(</span></span>
<span>      <span class="st">"callr::r"</span>,</span>
<span>      attributes <span class="op">=</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/as_attributes.html">as_attributes</a></span><span class="op">(</span><span class="va">options</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">hdrs</span> <span class="op">&lt;-</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/pack_http_context.html">pack_http_context</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hdrs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hdrs</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">options</span><span class="op">$</span><span class="va">env</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">hdrs</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">hdrs</span></span>
<span>  <span class="op">}</span></span></code></pre><p></p></div>
<p><code>options$env</code> contains the environment variables callr will set in the
newly started R process. This is where we need to add the output of
<code><a href="pack_http_context.html">pack_http_context()</a></code>, which contains the serialized representation
of the active span, if there is any.</p>
<p>Additionally, the subprocess needs to pick up the span context from the
environment variables. The <code>callr:::common_hook()</code> internal function
contains the code that the subprocess runs at startup. Here we need to
add:</p>
<p></p><div class="sourceCode r"><pre><code><span>      <span class="va">has_otel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"TRACEPARENT"</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"otel"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span>envir <span class="op">=</span> <span class="va">env</span><span class="op">$</span><span class="va">`__callr_data__`</span>, <span class="st">"has_otel"</span>, <span class="va">has_otel</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">has_otel</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">hdrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          traceparent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"TRACEPARENT"</span><span class="op">)</span>,</span>
<span>          tracestate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"TRACESTATE"</span><span class="op">)</span>,</span>
<span>          baggage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"BAGGAGE"</span><span class="op">)</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>        <span class="va">prtctx</span> <span class="op">&lt;-</span> <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_http_context.html">extract_http_context</a></span><span class="op">(</span><span class="va">hdrs</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/reg.finalizer.html" class="external-link">reg.finalizer</a></span><span class="op">(</span></span>
<span>          <span class="va">env</span><span class="op">$</span><span class="va">`__callr_data__`</span>,</span>
<span>          <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="va">e</span><span class="op">$</span><span class="va">otel_span</span><span class="op">$</span><span class="fu">end</span><span class="op">(</span><span class="op">)</span>,</span>
<span>          onexit <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span></span>
<span>          envir <span class="op">=</span> <span class="va">env</span><span class="op">$</span><span class="va">`__callr_data__`</span>,</span>
<span>          <span class="st">"otel_span"</span>,</span>
<span>          <span class="fu">otel</span><span class="fu">::</span><span class="fu"><a href="../reference/start_span.html">start_span</a></span><span class="op">(</span></span>
<span>            <span class="st">"callr subprocess"</span>,</span>
<span>            options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="va">prtctx</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span></code></pre><p></p></div>
<p>First we check if the <code>TRACEPARENT</code> environment variable is set. This
contains the serialization of the parent span. If it exists and the otel
package is also available, then we extract the span context from the
environment variables, and start a new span that is a child span or the
remote span obtained from the environment variables. We also set up a
finalizer that closes this span when the R process terminates.</p>
</div>

    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># See above</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer></body></html>

